# Sprint 3 Setup Guide: LLM-Powered NPC Conversations

This guide explains how to set up and run Sprint 3, which implements basic NPC conversations using LLM (Large Language Model) integration.

## Prerequisites

1. **Docker and Docker Compose** - For running the services
2. **OpenAI API Key** - Required for LLM conversations
3. **Node.js 20+** - For development

## Setup Instructions

### 1. Environment Configuration

Create a `.env` file in the `web-api` directory:

```bash
cd web-api
cp config.example.js config.js  # Optional: modify if needed
```

**IMPORTANT:** Create a `.env` file in the `web-api` directory with your actual OpenAI API key:

```bash
# In the web-api directory
echo "OPENAI_API_KEY=your-actual-openai-api-key-here" > .env
```

Or create the file manually with this content:

```env
OPENAI_API_KEY=your-actual-openai-api-key-here
DB_HOST=postgres
DB_PORT=5432
DB_NAME=heartwood_db
DB_USER=heartwood_user
DB_PASSWORD=heartwood_password
REDIS_URL=redis://redis:6379
PORT=3000
NODE_ENV=development
```

**Note:** Without a valid OpenAI API key, the NPC conversations will not work.

### 2. Start the Services

Run all services using Docker Compose:

```bash
docker-compose up --build
```

This will start:
- **PostgreSQL** (port 5432) - Database with NPC data
- **Redis** (port 6379) - Queue for LLM processing
- **Web API** (port 3000) - REST API for NPC interactions
- **Game Server** (port 2567) - Colyseus multiplayer server
- **Client** (port 5173) - Phaser 3 game client

### 3. Install Dependencies

If you need to install dependencies manually:

```bash
# Web API
cd web-api
npm install

# Game Server
cd ../game-server
npm install

# Client
cd ../client
npm install
```

## How to Test Sprint 3

### 1. Access the Game

Open your browser and navigate to: `http://localhost:5173`

### 2. Find the NPC

- Use WASD or arrow keys to move your character
- Look for a **green-tinted character** named "Elara" at position (8, 6)
- This is our test NPC blacksmith

### 3. Start a Conversation

- Walk close to Elara (within 2 tiles)
- You'll see "Press E to talk" appear above her
- Press the **E key** to start a conversation

### 4. Chat with the NPC

- A dialogue UI will appear at the bottom of the screen
- Type your message and press **Enter**
- You'll see "Elara is typing..." while the LLM processes your message
- The NPC will respond with a unique, in-character message

### 5. Continue the Conversation

- Keep chatting! Each response is generated by the LLM
- Press **Escape** to close the dialogue

## Features Implemented

### âœ… Sprint 3 Deliverables

1. **Dialogue UI** - Text input, typing indicator, chat history
2. **NPC Interaction** - Press E near NPCs to start conversations
3. **LLM Integration** - OpenAI GPT-4o-mini for response generation
4. **Rate Limiting** - 1 message per 5 seconds per user
5. **Asynchronous Processing** - Redis queue for LLM jobs
6. **Database Integration** - Conversation logging

### ðŸŽ¯ Current NPC: Elara the Blacksmith

- **Personality**: Shy, thoughtful, loves flowers, dislikes loud noises
- **Location**: Position (8, 6) on the map
- **Appearance**: Green-tinted player sprite
- **Behavior**: Speaks in short, thoughtful sentences

## Architecture Overview

### Data Flow
1. **Player Input** â†’ Client dialogue UI
2. **HTTP Request** â†’ Web API `/npc/interact` endpoint
3. **Job Queue** â†’ Redis queue for processing
4. **LLM Worker** â†’ Processes conversation with OpenAI API
5. **Response** â†’ Client polls for completed response
6. **Database** â†’ Logs conversation history

### Key Components

- **DialogueManager** - Handles UI and HTTP communication
- **LLMWorker** - Processes conversations with OpenAI
- **NPC Routes** - REST API endpoints for NPC interactions
- **Database Schema** - NPCs, conversations, and relationships

## Troubleshooting

### Common Issues

1. **"NPC not found" error**
   - Check that the database is running and populated
   - Verify NPC exists: `http://localhost:3000/npc/list`

2. **"Rate limit exceeded"**
   - Wait 5 seconds between messages
   - This is intentional to manage API costs

3. **No response from NPC**
   - Check your OpenAI API key in the `.env` file
   - Look at web-api logs for errors: `docker-compose logs web-api`

4. **Connection errors**
   - Ensure all services are running: `docker-compose ps`
   - Check if ports are available (3000, 2567, 5173, 5432, 6379)

5. **"NPC not found" or database errors**
   - If you get database table errors, you may need to recreate the database:
   - `docker-compose down -v` (removes volumes)
   - `docker-compose up --build` (recreates with fresh database)

### Logs and Debugging

View logs for specific services:
```bash
docker-compose logs web-api    # Web API and LLM worker
docker-compose logs game-server # Colyseus server
docker-compose logs client     # Development server
docker-compose logs postgres   # Database
docker-compose logs redis      # Redis cache
```

## API Endpoints

### NPC Interaction
- `POST /npc/interact` - Start a conversation
- `GET /npc/conversation/:jobId` - Check response status
- `GET /npc/list` - List all NPCs

### Example API Usage

```javascript
// Start conversation
const response = await fetch('http://localhost:3000/npc/interact', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    npcId: 'elara_blacksmith',
    message: 'Hello there!'
  })
});

// Check for response
const statusResponse = await fetch(`http://localhost:3000/npc/conversation/${jobId}`);
```

## Next Steps (Sprint 4+)

Sprint 3 provides the foundation for:
- **Memory System** - NPCs remember previous conversations
- **Relationship Tracking** - Affection scores affect dialogue
- **Multiple NPCs** - Expand the world with more characters
- **Authentication** - User accounts and persistent characters
- **Multiplayer** - See other players' interactions

## Configuration

### OpenAI Model Settings
- **Model**: gpt-4o-mini (fast and cost-effective)
- **Max Tokens**: 150 (short responses)
- **Temperature**: 0.8 (creative but consistent)

### Rate Limiting
- **Conversation**: 1 message per 5 seconds per user
- **API**: Standard Express rate limiting

### Database Schema
- **npcs**: NPC data and constitutions
- **conversation_logs**: All player-NPC interactions
- **npc_relationships**: Future affection tracking

---

**Sprint 3 Complete!** ðŸŽ‰

You now have a working LLM-powered NPC conversation system. Players can walk up to Elara, press E, and have unique conversations powered by OpenAI's GPT model. 